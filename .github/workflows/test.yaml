name: Build and Commit Changes

on:
  workflow_dispatch:

jobs:
  build-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history to ensure 'gh-pages' branch is available

      - name: Set up Node.js environment
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Build project using Webpack/Rollup
        run: |
          npm i
          npm run build

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add -A
          git reset -- node_modules  # Unstage the node_modules changes

          # Check for changes
          if git diff --cached --exit-code; then
            echo "No changes to commit."
          else
            # Get current time in seconds since epoch
            current_time=$(date +%s)
            
            # Loop through changed files
            git diff --cached --name-only | while read -r file; do
              # Get file creation time in seconds since epoch
              file_creation_time=$(git log --diff-filter=A --format=%at -- "$file" | tail -1)

              # Check if file_creation_time is older than (120 seconds)
              if [ $((current_time - file_creation_time)) -gt 120 ]; then
                commit_message="Updated $file :inbox_tray:"
              else
                commit_message="Added $file :inbox_tray:"
              fi
              git commit -m "$commit_message" -- "$file"
            done
            git push
          fi
